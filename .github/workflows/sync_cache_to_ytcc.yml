name: Sync PGC cache to YTCC repos

on:
  push:
    branches: [ "main" ]
    paths:
      - "cache_token_*.json"
      - "pgc_cache/cache_token_*.json"
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1) YTAN Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout YTAN
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2) YTANÏóêÏÑú Ï∫êÏãú ÌååÏùº Î™©Î°ù ÏàòÏßë (Î£®Ìä∏/pgc_cache Îëò Îã§ ÏßÄÏõê)
      - name: Collect cache files from YTAN
        id: collect
        shell: bash
        run: |
          set -euo pipefail

          rm -rf _cache_src
          mkdir -p _cache_src
          shopt -s nullglob

          # Î£®Ìä∏
          for f in cache_token_*.json; do
            cp -f "$f" "_cache_src/"
          done

          # pgc_cache Ìè¥Îçî
          if [ -d "pgc_cache" ]; then
            for f in pgc_cache/cache_token_*.json; do
              cp -f "$f" "_cache_src/"
            done
          fi

          COUNT=$(ls -1 _cache_src 2>/dev/null | wc -l | tr -d ' ')
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          if [ "$COUNT" -eq 0 ]; then
            echo "‚ùå No cache_token_*.json found in YTAN (root or pgc_cache/)."
            exit 1
          fi

          echo "‚úÖ Found $COUNT cache file(s)."

      # 3) ÌÉÄÍ≤ü Î†àÌè¨ Î¶¨Ïä§Ìä∏(2Í∞ú)Ïóê ÎåÄÌï¥ ÏàúÏ∞® ÎØ∏Îü¨ÎßÅ
      - name: Mirror to target repos
        shell: bash
        env:
          YTCC_PAT: ${{ secrets.YTCC_PAT }}
        run: |
          set -euo pipefail

          TARGET_REPOS=(
            "hobam-enm/-TEST-YTCC-chatbot"
            "hobam-enm/YTCC-chatbot"
          )

          for REPO in "${TARGET_REPOS[@]}"; do
            echo "=============================="
            echo "üîÅ Syncing to: $REPO"
            echo "=============================="

            rm -rf _target_repo
            git clone --depth 1 --branch main "https://x-access-token:${YTCC_PAT}@github.com/${REPO}.git" _target_repo

            mkdir -p _target_repo/pgc_cache
            rm -f _target_repo/pgc_cache/cache_token_*.json
            cp -f _cache_src/cache_token_*.json _target_repo/pgc_cache/

            cd _target_repo
            if [ -z "$(git status --porcelain)" ]; then
              echo "‚úÖ No changes for $REPO"
              cd ..
              continue
            fi

            git config user.name  "ytan-cache-sync-bot"
            git config user.email "actions@users.noreply.github.com"

            git add pgc_cache/cache_token_*.json
            git commit -m "Sync PGC cache from YTAN @ ${GITHUB_SHA}"
            git push origin main

            cd ..
            echo "‚úÖ Pushed updates to $REPO"
          done
