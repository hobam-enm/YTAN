name: Sync PGC cache to YTCC repos

on:
  push:
    branches: [ "main" ]
    paths:
      - "cache_token_*.json"
      - "pgc_cache/cache_token_*.json"
  workflow_dispatch: {}

# ===== ë™ì‹œì„± ì œì–´ (í•µì‹¬ ìˆ˜ì • ì‚¬í•­) =====
# ë™ì¼í•œ ê·¸ë£¹ì˜ ì‘ì—…ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ëŒ€ê¸°ì‹œí‚µë‹ˆë‹¤.
# ì´ë¥¼ í†µí•´ ì•ì„  ì‘ì—…ì´ git pushë¥¼ ì™„ë£Œí•œ ë’¤ì— ë‹¤ìŒ ì‘ì—…ì´ ì‹¤í–‰ë˜ë¯€ë¡œ ì¶©ëŒì´ ë°©ì§€ë©ë‹ˆë‹¤.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # ===== 1. YTAN ì²´í¬ì•„ì›ƒ =====
      - name: Checkout YTAN
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ===== 2. YTANì—ì„œ ìºì‹œ íŒŒì¼ ìˆ˜ì§‘ =====
      # ë£¨íŠ¸ ë° pgc_cache í´ë” ë‚´ì˜ í† í° íŒŒì¼ì„ ì„ì‹œ í´ë”(_cache_src)ë¡œ í†µí•©
      - name: Collect cache files from YTAN
        id: collect
        shell: bash
        run: |
          set -euo pipefail

          # ì„ì‹œ ì†ŒìŠ¤ í´ë” ì´ˆê¸°í™”
          rm -rf _cache_src
          mkdir -p _cache_src
          shopt -s nullglob

          # 1) ë£¨íŠ¸ ê²½ë¡œ íŒŒì¼ ìˆ˜ì§‘
          for f in cache_token_*.json; do
            cp -f "$f" "_cache_src/"
          done

          # 2) pgc_cache í´ë” íŒŒì¼ ìˆ˜ì§‘ (í´ë” ì¡´ì¬ ì‹œ)
          if [ -d "pgc_cache" ]; then
            for f in pgc_cache/cache_token_*.json; do
              cp -f "$f" "_cache_src/"
            done
          fi

          # ìˆ˜ì§‘ëœ íŒŒì¼ ê°œìˆ˜ í™•ì¸
          COUNT=$(ls -1 _cache_src 2>/dev/null | wc -l | tr -d ' ')
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          # íŒŒì¼ì´ ì—†ìœ¼ë©´ ì—ëŸ¬ ì²˜ë¦¬í•˜ì—¬ ì¤‘ë‹¨
          if [ "$COUNT" -eq 0 ]; then
            echo "âŒ No cache_token_*.json found in YTAN (root or pgc_cache/)."
            exit 1
          fi

          echo "âœ… Found $COUNT cache file(s)."

      # ===== 3. íƒ€ê²Ÿ ë ˆí¬ ìˆœì°¨ ë¯¸ëŸ¬ë§ =====
      # ì •ì˜ëœ íƒ€ê²Ÿ ë¦¬í¬ì§€í† ë¦¬ ëª©ë¡ì— ëŒ€í•´ Clone -> Update -> Push ìˆ˜í–‰
      - name: Mirror to target repos
        shell: bash
        env:
          YTCC_PAT: ${{ secrets.YTCC_PAT }}
        run: |
          set -euo pipefail

          # ë™ê¸°í™”í•  íƒ€ê²Ÿ ë¦¬í¬ì§€í† ë¦¬ ëª©ë¡
          TARGET_REPOS=(
            "hobam-enm/-TEST-YTCC-chatbot"
            "hobam-enm/YTCC-chatbot"
            "hobam-enm/-TEST222-Chatbot"
          )

          for REPO in "${TARGET_REPOS[@]}"; do
            echo "=============================="
            echo "ğŸ” Syncing to: $REPO"
            echo "=============================="

            # íƒ€ê²Ÿ ë¦¬í¬ì§€í† ë¦¬ í´ë¡  (ì„ì‹œ í´ë” ì‚¬ìš©)
            rm -rf _target_repo
            git clone --depth 1 --branch main "https://x-access-token:${YTCC_PAT}@github.com/${REPO}.git" _target_repo

            # íƒ€ê²Ÿ í´ë” ì¤€ë¹„ ë° ê¸°ì¡´ í† í° ì‚­ì œ (ê°±ì‹ ì„ ìœ„í•´)
            mkdir -p _target_repo/pgc_cache
            rm -f _target_repo/pgc_cache/cache_token_*.json
            
            # ìµœì‹  í† í° íŒŒì¼ ë³µì‚¬
            cp -f _cache_src/cache_token_*.json _target_repo/pgc_cache/

            # ë³€ê²½ ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹/í‘¸ì‹œ
            cd _target_repo
            
            if [ -z "$(git status --porcelain)" ]; then
              echo "âœ… No changes for $REPO"
              cd ..
              continue
            fi

            # ë´‡ ê³„ì • ì„¤ì •
            git config user.name  "ytan-cache-sync-bot"
            git config user.email "actions@users.noreply.github.com"

            # ì»¤ë°‹ ë° í‘¸ì‹œ
            git add pgc_cache/cache_token_*.json
            git commit -m "Sync PGC cache from YTAN @ ${GITHUB_SHA}"
            
            # concurrency ì„¤ì • ë•ë¶„ì— ì—¬ê¸°ì„œ ì¶©ëŒ ë‚  í™•ë¥ ì´ ê±°ì˜ ì—†ìŒ
            git push origin main

            cd ..
            echo "âœ… Pushed updates to $REPO"
          done
